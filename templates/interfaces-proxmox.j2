# Please do NOT modify this file directly, unless you know what
# you're doing.
#
# If you want to manage parts of the network configuration manually,
# please utilize the 'source' or 'source-directory' directives to do
# so.
# PVE will preserve these directives, but will NOT read its network
# configuration from sourced files, so do not attempt to move any of
# the PVE managed interfaces into external files!

auto lo
iface lo inet loopback
{% if system_network_ipv6['floatip'] %}
        up ip -6 addr add {{ system_network_ipv6['floatip'] }} dev $IFACE
{% endif %}

auto {{ 'eth0' if system_network_pin else ansible_default_ipv4['alias'] }}
iface {{ 'eth0' if system_network_pin else ansible_default_ipv4['alias'] }} inet static
        address {{ ansible_default_ipv4['address'] }}/{{ ansible_default_ipv4['prefix'] }}
        gateway {{ ansible_default_ipv4['gateway'] }}
{% if ansible_default_ipv4['mtu'] != 1500 %}
        mtu {{ ansible_default_ipv4['mtu'] }}
{% endif %}
{% if system_network_local_dns %}
        dns-nameservers 127.0.0.1 {{ ansible_default_ipv4['address'] }}{% for ns in system_network_dns -%}
        {% if ('127.0.0.1' not in ns) and (ansible_default_ipv4['address'] not in ns) %} {{ ns }}{% endif %}{% endfor %}
{% elif system_network_dns != '' %}
        dns-nameservers{% for ns in system_network_dns %} {{ ns }}{% endfor %}

{% endif %}
{% if system_network_search_dns and ansible_dns['search'] is defined and ansible_dns['search']|length > 0 %}
        dns-search{% for search in ansible_dns['search'] %} {{ search }}{% endfor %}
{% endif %}
{% if system_network_pin and ansible_default_ipv4['alias'] != 'eth0' %}

# temporary define interface
allow-hotplug {{ ansible_default_ipv4['alias'] }}
iface {{ ansible_default_ipv4['alias'] }} inet static
        address {{ ansible_default_ipv4['address'] }}/{{ ansible_default_ipv4['prefix'] }}
        gateway {{ ansible_default_ipv4['gateway'] }}
{% if ansible_default_ipv4['mtu'] != 1500 %}
        mtu {{ ansible_default_ipv4['mtu'] }}
{% endif %}

{% endif %}
{% if system_network_ipv6 %}

iface {{ 'eth0' if system_network_pin else ansible_default_ipv4['alias'] }} inet6 static
        address {{ system_network_ipv6['address'] | ansible.utils.ipmath('296') }}/128
        gateway {{ system_network_ipv6['gateway'] }}
{% if ansible_default_ipv4['mtu'] != 1500 %}
        mtu {{ ansible_default_ipv4['mtu'] }}
{% endif %}
{% if system_network_ipv6['floatip'] %}
        up ip -6 neigh add proxy {{ system_network_ipv6['floatip'] }} dev $IFACE
{% endif %}

auto vmbr0
{% if system_network_ipv4['address'] %}
iface vmbr0 inet static
        address {{ system_network_ipv4['address'] }}
        bridge-ports none
        bridge-stp off
        bridge-fd 0

{% endif %}
iface vmbr0 inet6 static
{% if system_network_ipv6['address'].endswith('/64') %}
        address {{ system_network_ipv6['address'] | ansible.utils.ipmath('100') }}/64
{% else %}
        address {{ system_network_ipv6['address'] }}
{% endif %}
{% if not system_network_ipv4['address'] %}
        bridge-ports none
        bridge-stp off
        bridge-fd 0
{% endif %}
{% endif %}

#
source /etc/network/interfaces.d/*
